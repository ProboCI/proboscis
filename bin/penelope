#! /usr/bin/env node
var parse = require('shell-quote').parse;
var es = require('event-stream');
var async = require('async');
var fs = require('fs');
var util = require('util');
var path = require('path');

var yargs = require('yargs');
var Penelope = require('../index');
var runner = new Penelope();

argv = yargs
  .usage('penelope -c "echo foo" -c "echo bar"')
  .default('help', false)
  .describe('help', 'Display this help text.')
  .alias('help', 'h')
  .alias('command', 'c')
  .describe('command', 'A command to run as a child.')
  .argv;

if (argv.help) {
  yargs.showHelp();
  process.exit(0);
}

var commands = argv.command;

if (typeof argv.command === 'string') {
  commands = [ argv.command ];
}

runner.eventStream
  .pipe(es.stringify())
  .pipe(process.stdout);

var i = null;
for (i in commands) {
  var command = commands[i];
  var args = parse(command);
  var binary = args.shift();
  var name = binary;
  runner.runCommand(name, binary, args);
}

// TODO: Move this into it's own include module.
var files = argv._;
if (files.length > 0) {
  var fileLoadHandler = function(error, files) {
    if (error && error.code === 'ENOENT') {
      var message = 'File cannot be loaded, this may be bad permissions or a bad file path `%s`.';
      message = util.format(message, error.path);
      process.exit(1);
    }
  };

  // Map resolve the paths
  files = files.map(function(localPath) {
    return path.resolve(path.join(process.cwd(), localPath));
  });

  var readFile = function(filePath, done) {
    fs.readFile(filePath, function(error, buffer) {
      if (error) {
        return done(error);
      }
      try {
        var config = JSON.parse(buffer.toString('utf8'));
        done(error, {filePath: filePath, config: config});
      }
      catch (e) {
        console.error(util.format('Parsing file `%s` failed.', filePath), e);
        done(new Error('Parsing file failed.'));
      }
    });
  };
  async.map(files, readFile, fileLoadHandler);
}
